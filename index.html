<!DOCTYPE html>

<html>
    <head>
        <title>Play Chunk Download Test</title>
    </head>
    
    <body>
        <input id="audio-url-input" type="text" placeholder="Enter audio URL">
        <button id="download-button">Download</button>
        <audio controls></audio>
        
        <script type="module">
            
            document.getElementById(`#download-button`).addEventListener('click', async () => {
                const audioURL = document.getElementById('audio-url-input').value;
                
                await clear();
                
                await fetchAndSaveAudioFile();
            });
            
            import { set, get, clear } from 'https://unpkg.com/idb-keyval/dist/idb-keyval.mjs';
            
            const oneMegabyteInBytes = 1048576;
            const chunkSize = oneMegabyteInBytes;
            
            async function fetchAndSaveAudioFile(
                url,
                index = 0,
                rangeStart = 0,
                rangeEnd = chunkSize
            ) {
                console.log(`rangeStart`, rangeStart);
                console.log(`rangeEnd`, rangeEnd);
                    
                const audioFileResponse = await fetch(url, {
                    headers: {
                        'Range': `bytes=${rangeStart}-${rangeEnd}`
                    }
                });
                    
                const audioFileBlob = await audioFileResponse.blob();
                    
                await set(`chunk-${index}`, audioFileArrayBuffer);
                    
                const responseContentLength = audioFileResponse.headers.get('Content-Length');
                    
                if (
                    parseInt(responseContentLength) < chunkSize + 1
                ) {
                    return;
                }
                    
                await fetchAndSaveAudioFile(url, index + 1, rangeStart + chunkSize, rangeEnd + chunkSize);
            }
        </script>
    </body>
</html>
